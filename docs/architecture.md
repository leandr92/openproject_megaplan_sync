# Архитектура мигратора Megaplan → OpenProject

## Цели
- Разовая миграция существующих задач из Megaplan в OpenProject с сохранением иерархии, исполнителей, комментариев и вложенных файлов.
- Периодическая синхронизация новых и изменённых задач до полного отказа от Megaplan.
- Трассируемость: возможность повторного запуска, хранилище соответствий идентификаторов и отчётность по результатам синхронизации.

## Общий обзор
Приложение реализовано как консольный Python-инструмент, состоящий из трёх основных слоёв:
1. **Клиенты API** (`clients`): изолируют детали REST API Megaplan и OpenProject, предоставляя высокоуровневые методы.
2. **Сервисные компоненты** (`services`): бизнес-логика миграции, маппинг сущностей, разрешение ссылок и выдача команд клиентам API.
3. **Инфраструктура**: конфигурация, логирование, хранилище соответствий идентификаторов (`MappingStore` на SQLite), обработка CLI-команд.

```
+----------------------+           +---------------------------+
| Megaplan REST API    | <--->     | clients.megaplan          |
+----------------------+           +---------------------------+
                                                |
                                                v
                                        +---------------+
                                        | services.sync |
                                        +---------------+
                                                |
                                                v
+----------------------+           +---------------------------+
| OpenProject REST API | <--->     | clients.openproject       |
+----------------------+           +---------------------------+
```

## Конфигурация
Конфигурация хранится в YAML-файле `config.yaml` (или в переменных окружения) и включает:
- Учетные данные и базовые URL для Megaplan и OpenProject (Basic Auth: `username`/`password`).
- Правила соответствия проектов (`megaplan_project_id` → `openproject_project_id`).
- Параметры синхронизации: размер страниц, временные фильтры, режим зеркалирования.
- Путь к рабочему каталогу для временных файлов и SQLite-базы.

Загрузка конфигурации выполняется классом `AppConfig`, который объединяет значения из файла и окружения и валидирует их (используется `pydantic`).

## Хранилище соответствий
`MappingStore` управляет SQLite-базой, содержащей:
- `tasks (megaplan_id TEXT PRIMARY KEY, openproject_id TEXT, synced_at DATETIME)`
- `users`, `projects`, `attachments`, `sync_state` (хранение временных меток последней успешной синхронизации по проектам)

Хранилище обеспечивает:
- Поиск по обоим идентификаторам
- Запись после успешного создания сущности в OpenProject
- Поддержку транзакций и идемпотентности при повторном запуске

## Магистральная логика
`services.sync.TaskSyncService` реализует сценарии:
- `initial_migration(project_mapping)` — выгрузка всех задач из Megaplan постранично, построение дерева (родитель → дети), создание пользователей/групп по необходимости, создание задач в OpenProject с установкой связей, перенос комментариев и файлов.
- `incremental_sync(project_mapping, since)` — получение обновлений по временной метке, синхронизация новых или изменённых задач, комментариев и приложений, актуализация статусов.

### Обработка иерархии
1. Загрузка всех задач проекта Megaplan с полями `ParentTask`, `Level`.
2. Построение ориентированного дерева в памяти.
3. Топологическая сортировка: сначала родительские задачи, затем дочерние.
4. Создание задач в OpenProject с указанием `parent_id`. Для уже существующих задач используется `MappingStore`.

### Комментарии и вложения
- После создания задачи копируются комментарии (без системных, если так конфигурировано).
- Вложения скачиваются во временный каталог и загружаются во вложения OpenProject (с сохранением имени файла и автора комментария).
- Лимит размера файла контролируется конфигурацией.

## CLI и сценарии запуска
Входная точка `python -m openproject_megaplan_sync.cli` (на базе `typer`) предоставляет команды:
- `initial-sync --config config.yaml`
- `sync-updates --since 2024-01-01T00:00:00 --config config.yaml`
- `verify --dry-run` для проверки соединения и прав (создаёт/читает пробные задачи и пользователей)

## Логирование и отчётность
- Используется `logging` с ротацией файлов (`logs/sync.log`).
- Каждая синхронизация фиксирует сводный отчёт (кол-во созданных, обновлённых, пропущенных задач, ошибки) в CSV/JSON отчёт.
- Ошибки API переводятся в единый набор исключений, что облегчает повторные попытки и анализ.

## Расширяемость
- Поддерживаются пользовательские мапперы статусов, типов задач и полей через YAML.
- Возможность добавить поддержку двусторонней синхронизации, если потребуется, за счёт расширения сервисного слоя.

## Ограничения/предположения
- Предполагается наличие учётных записей с правами чтения/записи задач, пользователей, комментариев, файлов.
- Миграция пользователей может потребовать предварительного создания аккаунтов в OpenProject; модуль поддерживает создание локальных пользователей с временными паролями.
- Ограничение на размер вложений: большие файлы пропускаются с логом.

